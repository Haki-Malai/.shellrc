#!/usr/bin/env bash
set -uo pipefail

YELLOW=$'\033[33m'
RESET=$'\033[0m'

warn() {
  printf "%bWarning:%b %s\n" "$YELLOW" "$RESET" "$1" >&2
}

staged() { git diff --cached --name-only --diff-filter=ACMR -z; }

# warn on env files and keys
if staged | tr '\0' '\n' | grep -E '^(env/env\.sh|\.env(\.local)?|.*\.(pem|pfx|p12|key))$' >/dev/null; then
  warn "env files or keys are staged. Commit only env/env.example.sh."
fi

# warn on secret patterns
if git diff --cached -U0 | grep -E \
 '(BEGIN (RSA|EC|OPENSSH) PRIVATE KEY|AKIA[0-9A-Z]{16}|AIza[0-9A-Za-z\-_]{35}|gh[pous]_[A-Za-z0-9]{36,}|xox[baprs]-[A-Za-z0-9-]{10,}|sk-[A-Za-z0-9]{20,}|password\s*=|secret\s*=)' -q; then
  warn "possible secrets detected in staged changes."
fi

if command -v gitleaks >/dev/null 2>&1; then
  if ! gitleaks protect --staged --no-banner; then
    warn "gitleaks detected potential secrets in staged changes."
  fi
fi
